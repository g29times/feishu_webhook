# 网页便签功能设计方案

## 1. 需求分析
用户希望在现有“划线发送”插件基础上，增加“网页便签”功能，主要解决以下痛点：
-   **适用场景**：针对无文字（纯图片）网站或不需要划线的场景，记录对网页的整体意见。
-   **持久化**：笔记需绑定 URL，下次访问时可见。
-   **交互**：提供侧边栏笔记区，随 Tab 切换自动展示对应页面的笔记。
-   **存储**：基于浏览器本地存储，无需后端。

## 2. 技术选型
鉴于插件现有架构（Content Script 注入），采用 **Content Script 注入侧边栏 (In-Page Sidebar)** 的方案最为轻量且符合需求。

### 为什么不使用 Chrome Side Panel API?
虽然 Chrome Side Panel API 是原生侧边栏，但它是一个全局单例视图，需要复杂的 `tabs.onActivated` 监听来手动刷新内容以匹配当前 Tab。
而 **Content Script 注入** 方案：
1.  **天然隔离**：每个 Tab 里的页面都有自己独立的 DOM，注入的侧边栏天然与页面绑定。切换 Tab 就是切换页面，笔记内容自然随之改变。
2.  **开发成本低**：复用现有的 `content.js` 和 CSS 注入逻辑。

## 3. 详细设计

### 3.1 UI 设计
采用 **“双按钮分离”** 策略，确保新老功能互不干扰。

1.  **原有的“划线浮动按钮” (保持不变)**:
    -   **触发机制**：仅在用户选中网页文本时出现。
    -   **位置**：跟随选中的文本区域。
    -   **生命周期**：瞬时态（选中出现，取消选择消失）。
    -   **用途**：快速发送选中的文本。

2.  **新增的“笔记入口按钮” (Sidebar Toggle)**:
    -   **位置**：屏幕右侧边缘垂直居中（或右下角），固定定位 (`position: fixed`)。
    -   **样式**：半透明圆形图标（悬浮球 FAB），内置“笔记”或“编辑”图标，不遮挡正文浏览。
    -   **生命周期**：常驻态（页面加载即显示，一直存在）。
    -   **交互**：
        -   点击 -> 从右侧滑出侧边栏。
        -   再次点击（或点击页面遮罩） -> 收起侧边栏。
    -   **防冲突设计**：
        -   即使用户打开了侧边栏，如果在左侧网页正文中选中文本，原有的“划线浮动按钮”依然会正常显示在文本上方。用户可以选择将选中文本发送，或者复制粘贴到右侧打开的笔记栏中。

3.  **侧边笔记栏 (Note Drawer)**:
    -   **位置**：屏幕右侧，固定定位 (`position: fixed; right: 0; top: 0; height: 100vh;`)。
    -   宽度：约 300px。
    -   状态：默认隐藏（通过 `transform: translateX(100%)` 隐藏），激活时滑出。
    -   **内部结构**:
        -   **Header**: 标题 "当前页面笔记" + 关闭按钮。
        -   **List**: 滚动区域，显示历史笔记卡片（包含内容、时间、删除按钮）。
        -   **Footer**: 多行输入框 (`textarea`) + "添加笔记" 按钮 + "发送到飞书" 按钮（复用 Webhook 功能）。

### 3.2 数据存储设计
使用 `chrome.storage.local` 进行持久化存储。

-   **Storage Key**: `notes_${URL}`
    -   为了区分不同页面，使用当前页面的 `window.location.href` 作为唯一标识。
    -   *优化点*：可以考虑去除 hash 或部分 query params，但为了简单准确，第一版先用完整 URL。
-   **Data Structure**:
    ```json
    {
      "notes_https://www.example.com/page1": [
        {
          "id": 1716192000000,
          "content": "这个页面的排版很有意思，参考一下。",
          "createdAt": 1716192000000
        },
        {
          "id": 1716192050000,
          "content": "图片加载太慢了。",
          "createdAt": 1716192050000
        }
      ]
    }
    ```

### 3.3 核心逻辑流程 (`content.js`)

#### 初始化
1.  页面加载时，注入“悬浮入口按钮”。
2.  读取 `chrome.storage.local` 检查当前 URL 是否已有笔记。
    -   如果有笔记，可以给入口按钮加个红点或数字标记，提示用户有历史记录。

#### 打开侧边栏
1.  点击入口按钮，创建/显示侧边栏 DOM。
2.  从 `chrome.storage.local` 读取当前 URL 的笔记列表。
3.  渲染笔记列表到 UI。

#### 添加笔记
1.  用户在侧边栏输入内容，点击“添加”。
2.  构造笔记对象 `{ id: Date.now(), content: inputVal, createdAt: Date.now() }`。
3.  读取当前存储 -> 追加新笔记 -> 写入 `chrome.storage.local`。
4.  重新渲染列表。
5.  清空输入框。

#### 发送到飞书 (集成现有功能)
1.  在单条笔记或输入框旁增加“发送”图标。
2.  点击后，直接复用现有的 `sendToWebhook(text)` 函数。

### 3.4 文件修改计划
1.  **`manifest.json`**: 无需修改权限（已有 `storage`），无需新增配置。
2.  **`content.css`**: 新增侧边栏、笔记卡片、输入框的样式定义。
3.  **`content.js`**:
    -   新增 `NoteManager` 类或一组函数，管理笔记 UI 和数据。
    -   新增 `createSidePanel()`, `renderNotes()`, `saveNote()` 等方法。
    -   保持原有的划线功能不受影响。

## 4. 后续优化 (V2)
-   支持云端同步（需后端）。
-   支持对笔记进行编辑。
-   支持截取当前视口截图作为笔记附件。
